import{_ as Te,K as Me,q as $e,u as qe,a as xe,r,y as h,w as de,o as Ie,e as u,s as d,f as a,h as ie,D as ve,t as s,n as p,i as k,F as D,B as N,b as U,v as pe,E as _e,m as je,p as Le}from"./index-Cre1HAju.js";import{a as be}from"./apiService-CkcypGzS.js";import{c as E}from"./contractService-BfMfjQtp.js";import{F as Oe}from"./FileUploadModal-hE2Cp0TC.js";import{F as Pe}from"./FuturisticPopup-CYFaQ6Y3.js";import"./api-D_YAzMdB.js";import"./TransferService-Dw1qUyUj.js";import"./check-DAKitar3.js";const Je={class:"page-header"},ze={key:0,class:"balance-error-message"},Ke={class:"error-text"},We={class:"header-actions"},Ge={class:"transaction-info"},He={class:"transaction-label"},Qe={class:"transaction-id"},Xe=["disabled"],Ye={key:0,class:"loading-container"},Ze={key:1,class:"error-container"},et={key:2,class:"data-container"},tt={class:"card-container table-container"},at={class:"transfer-table"},nt={class:"action-column"},ot=["onClick","disabled"],st=["onClick"],lt={key:1,class:"validation-success-indicator"},rt={class:"number-cell"},ct=["onUpdate:modelValue","onInput","placeholder","readonly"],ut={class:"number-cell"},dt=["onUpdate:modelValue","onInput","placeholder","readonly"],it={class:"number-cell"},vt={class:"name-display"},pt={class:"number-cell"},_t={class:"name-display"},bt={class:"number-cell"},ft={class:"name-display"},ht={class:"number-cell"},gt={class:"name-display"},mt={class:"name-display"},yt=["onUpdate:modelValue","onChange","disabled"],wt={value:""},Ct=["value"],Ft={class:"name-display"},St=["onUpdate:modelValue","onChange","disabled"],kt={value:""},Et=["value"],Rt={class:"summary-row"},At={class:"number-cell"},Dt={class:"number-cell"},Nt={class:"number-cell"},Ut={class:"number-cell"},Bt={class:"number-cell"},Vt={class:"number-cell"},Tt={colspan:"4",class:"summary-label"},Mt={colspan:"11",class:"add-row-cell"},$t=["disabled"],qt={class:"total-info"},xt={class:"action-buttons"},It=["disabled"],jt=["disabled"],Lt=["disabled"],Ot={class:"error-modal-header"},Pt={class:"error-modal-body"},Jt={class:"error-list"},zt={__name:"ContractDetail",setup(Kt){const j=Me(),fe=$e(),B=qe(),L=xe(),_=r(null),c=r([]),V=r(!0),T=r(!1);r(null),r(null);const M=r([]),O=r(!1),P=r(!1),$=r([]),J=r(!1),z=r(!1),C=r([]),b=r(!1),y=r(null),v=r("not yet sent for approval"),K=h(()=>c.value.some(e=>e.validation_errors&&e.validation_errors.length>0)),f=h(()=>v.value==="is rejected"||v.value==="not yet sent for approval"),W=h(()=>(v.value==="is rejected"||v.value==="not yet sent for approval")&&b.value),G=h(()=>y.value&&y.value.balanced===!1||K.value?!1:v.value==="not yet sent for approval"),H=h(()=>y.value&&y.value.balanced===!1||K.value?!1:v.value==="is rejected"),Q=h(()=>v.value==="is rejected"||v.value==="not yet sent for approval"),he=h(()=>{const e=v.value;if(o.value)switch(e){case"approved":return"معتمد";case"is rejected":return"مرفوض";case"watting for approval":return"في انتظار الموافقة";case"not yet sent for approval":return"لم يتم الإرسال للموافقة";default:return e}else switch(e){case"watting for approval":return"Waiting for approval";default:return e.charAt(0).toUpperCase()+e.slice(1)}}),ge=h(()=>{switch(v.value){case"approved":return"status-approved";case"is rejected":return"status-rejected";case"watting for approval":return"status-waiting";case"not yet sent for approval":return"status-not-sent";default:return""}}),me=h(()=>B.darkMode),o=h(()=>B.language==="ar"),ye=h(()=>B.language==="ar"),F=h(()=>{const e=c.value;return{toSum:e.reduce((n,t)=>n+(parseFloat(t.to_center)||0),0),fromSum:e.reduce((n,t)=>n+(parseFloat(t.from_center)||0),0),encumbranceSum:e.reduce((n,t)=>n+(parseFloat(t.encumbrance)||0),0),availableBudgetSum:e.reduce((n,t)=>n+(parseFloat(t.available_budget)||0),0),actualSum:e.reduce((n,t)=>n+(parseFloat(t.actual)||0),0),approvedBudgetSum:e.reduce((n,t)=>n+(parseFloat(t.approved_budget)||0),0)}}),X=async()=>{O.value=!0,P.value=!1;try{const e=await be.accountEntities.getEntities();e.data&&(M.value=e.data)}catch(e){console.error("Failed to fetch cost center entities:",e),P.value=!0}finally{O.value=!1}},Y=async()=>{J.value=!0,z.value=!1;try{const e=await be.accountEntities.getAccounts();e.data&&e.data.data&&($.value=e.data.data)}catch(e){console.error("Failed to fetch account entities:",e),z.value=!0}finally{J.value=!1}},Z=e=>{if(!e)return"";const n=M.value.find(t=>t.entity===e);return n?n.alias_default:""},we=(e,n)=>{const t=n.target.value;e.cost_center_code=t,e.cost_center_name=Z(t),e.lastChangedField="cost_center_code",se(e),R()},ee=e=>{if(!e)return"";const n=$.value.find(t=>t.account===e);return n?n.alias_default:""},Ce=(e,n)=>{const t=n.target.value;e.account_code=t,e.account_name=ee(t),e.lastChangedField="account_code",se(e),R()},te=(e,n)=>{const t=`${n}_input`,i=e[t];if(!i){e[n]=null;return}const l=i.replace(/[^\d.-]/g,"").replace(/--/g,"-").replace(/\.+/g,".");/^-?\d*\.?\d*$/.test(l)?(e[t]=l,e[n]=parseFloat(l)||0):e[t]=e[n]?e[n].toString():"",R()},Fe=()=>{c.value.forEach(e=>{e.to_center_input=e.to_center!==null?e.to_center.toString():"",e.from_center_input=e.from_center!==null?e.from_center.toString():"",e.encumbrance_input=e.encumbrance!==null?e.encumbrance.toString():"",e.available_budget_input=e.available_budget!==null?e.available_budget.toString():"",e.actual_input=e.actual!==null?e.actual.toString():"",e.approved_budget_input=e.approved_budget!==null?e.approved_budget.toString():""})},ae=()=>{const e={transaction:_.value,cost_center_code:"",cost_center_name:"",account_code:"",account_name:"",approved_budget:0,available_budget:0,from_center:0,from_center_input:"",to_center:0,to_center_input:"",encumbrance:0,actual:0,done:1,financialDataFromApi:!1,lastChangedField:null};c.value.push(e),b.value=!0},g=(e,n="info",t=null)=>{let i="";return n==="success"?i=o.value?"نجاح!":"Success!":n==="error"?i=o.value?"خطأ!":"Error!":n==="warning"?i=o.value?"تحذير!":"Warning!":i=o.value?"تنبيه!":"Notice!",le.value=n,re.value=i,ce.value=e,ue.value=t||(n==="success"?3e3:0),I.value=!0,new Promise(l=>{A.value=()=>{l({dismiss:"close"})}})},Se=()=>{A.value&&(A.value(),A.value=null)},ke=async()=>{try{const e=c.value.filter(t=>t.cost_center_code&&t.account_code);if(!e.length){g(o.value?"لا توجد بيانات صالحة للإرسال":"No valid rows to send","warning");return}const n=e.map(t=>({transaction:_.value,cost_center_code:t.cost_center_code,cost_center_name:t.cost_center_name,account_code:t.account_code,account_name:t.account_name,approved_budget:parseFloat(t.approved_budget)||0,available_budget:parseFloat(t.available_budget)||0,from_center:parseFloat(t.from_center)||0,to_center:parseFloat(t.to_center)||0,encumbrance:parseFloat(t.encumbrance)||0,actual:parseFloat(t.actual)||0,done:1}));await E.createContract(n,L.token),await g(o.value?"تم إنشاء العقد بنجاح":"Contract created successfully","success"),await S(),b.value=!1,C.value=JSON.parse(JSON.stringify(c.value))}catch(e){g(o.value?"فشل في إنشاء العقد":"Failed to create contract","error"),console.error("Error creating contract:",e)}},Ee=e=>{c.value.length>1?(c.value.splice(e,1),b.value=!0):g(o.value?"يجب أن يكون هناك صف واحد على الأقل":"At least one row must exist","warning")},R=()=>{if(!C.value||C.value.length===0){b.value=c.value.length>0;return}if(C.value.length!==c.value.length){b.value=!0;return}for(let e=0;e<c.value.length;e++){const n=c.value[e];if(!n.contract_id){b.value=!0;return}const t=C.value.find(w=>w.contract_id===n.contract_id);if(!t){b.value=!0;return}const i=["approved_budget","available_budget","from_center","to_center","encumbrance","actual"];for(const w of i)if(parseFloat(t[w]||0)!==parseFloat(n[w]||0)){b.value=!0;return}const l=["cost_center_code","cost_center_name","account_code","account_name"];for(const w of l)if(t[w]!==n[w]){b.value=!0;return}}b.value=!1};de(()=>c.value,()=>{R()},{deep:!0});const S=async()=>{V.value=!0,T.value=!1;try{const e=await E.getContractDetails(_.value);e&&e.summary?(y.value=e.summary,e.summary.status?v.value=e.summary.status:e.status&&e.status.status?v.value=e.status.status:v.value="not yet sent for approval",c.value=e.transfers||[]):(c.value=e,y.value=null,v.value="not yet sent for approval"),Fe(),C.value=JSON.parse(JSON.stringify(c.value)),b.value=!1}catch(e){T.value=!0,console.error("Failed to load contract data:",e)}finally{V.value=!1}},m=e=>e==null?null:new Intl.NumberFormat(o.value?"ar-SA":"en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(e),Re=async()=>{try{await E.submitContractRequest(_.value),await g(o.value?"تم تقديم الطلب بنجاح":"Request submitted successfully","success"),fe.push("/contracts")}catch{g(o.value?"فشل في تقديم الطلب":"Failed to submit request","error")}},Ae=async()=>{try{await E.reopenContractRequest(_.value),await g(o.value?"تم إعادة فتح الطلب بنجاح":"Request reopened successfully","success"),await S()}catch{g(o.value?"فشل في إعادة فتح الطلب":"Failed to reopen request","error")}},De=async()=>{try{const e=await E.generateReport(_.value),n=window.URL.createObjectURL(e),t=document.createElement("a");t.href=n,t.setAttribute("download",`contract-report-${_.value}.pdf`),document.body.appendChild(t),t.click(),t.remove(),window.URL.revokeObjectURL(n),g(o.value?"تم إنشاء التقرير بنجاح":"Report generated successfully","success",3e3)}catch{g(o.value?"فشل في إنشاء التقرير":"Failed to generate report","error")}};de(()=>j.params.id,e=>{e&&(_.value=parseInt(e,10),S())},{immediate:!0}),Ie(()=>{_.value=parseInt(j.params.id,10),_.value?(S(),X(),Y()):(c.value=[],ae(),X(),Y())});const q=r(!1),ne=r([]),Ne=e=>{ne.value=e,q.value=!0},oe=()=>{q.value=!1},x=r(!1),Ue=()=>{x.value=!0},Be=()=>{x.value=!1},Ve=()=>{S()},se=async e=>{if(!(!e.cost_center_code||!e.account_code))try{const n=await E.getPivotFundDetails(e.cost_center_code,e.account_code);if(n&&n.data){const t=n.data;e.actual=parseFloat(t.actual)||0,e.available_budget=parseFloat(t.fund)||0,e.approved_budget=parseFloat(t.budget)||0,e.encumbrance=parseFloat(t.encumbrance)||0,e.financialDataFromApi=!0,R()}}catch(n){n.response&&n.response.status===404?(g(o.value?`لا توجد بيانات لهذا التحديد. المركز: ${e.cost_center_code}, الحساب: ${e.account_code}`:`This doesn't have data for Cost Center: ${e.cost_center_code}, Account: ${e.account_code}`,"warning"),e.lastChangedField==="account_code"?(e.account_code="",e.account_name=""):(e.cost_center_code="",e.cost_center_name=""),e.actual=0,e.available_budget=0,e.approved_budget=0,e.encumbrance=0,e.financialDataFromApi=!1):console.error("Failed to fetch pivot fund details:",n)}},I=r(!1),le=r("success"),re=r(""),ce=r(""),ue=r(0),A=r(null);return(e,n)=>(d(),u("div",{class:p(["contract-request-page",{"dark-mode":me.value,rtl:ye.value}])},[a("div",Je,[y.value&&!y.value.balanced?(d(),u("div",ze,[n[2]||(n[2]=a("div",{class:"error-icon"},"!",-1)),a("span",Ke,s(o.value?"الميزان غير متوازن. يرجى مراجعة قيم العقد.":"Unbalanced contract. Please review your contract values."),1)])):ie("",!0),a("div",We,[a("div",Ge,[a("span",He,s(o.value?"رقم المعاملة:":"Transaction ID:"),1),a("span",Qe,s(_.value),1),a("span",{class:p(["status-indicator",ge.value])},s(he.value),3)]),a("button",{class:p(["btn-header-create",{"btn-disabled":!W.value}]),onClick:ke,disabled:!W.value},[n[3]||(n[3]=a("span",{class:"btn-icon"},"✓",-1)),k(" "+s(o.value?"حفظ":"Save"),1)],10,Xe)])]),V.value?(d(),u("div",Ye,[n[4]||(n[4]=a("div",{class:"loading-spinner"},null,-1)),a("p",null,s(o.value?"جاري التحميل...":"Loading..."),1)])):T.value?(d(),u("div",Ze,[n[5]||(n[5]=a("div",{class:"error-icon"},"!",-1)),a("p",null,s(o.value?"حدث خطأ أثناء تحميل البيانات":"Error loading data"),1),a("button",{class:"btn-retry",onClick:S},s(o.value?"إعادة المحاولة":"Retry"),1)])):(d(),u("div",et,[a("div",tt,[a("table",at,[a("thead",null,[a("tr",null,[n[6]||(n[6]=a("th",{class:"action-column"},null,-1)),a("th",null,s(o.value?"إلى":"To"),1),a("th",null,s(o.value?"من":"From"),1),a("th",null,s(o.value?"حقًا ماليًا":"Encumbrance"),1),a("th",null,s(o.value?"الموازنة المتاحة":"Available Budget"),1),a("th",null,s(o.value?"الحالى":"Actual"),1),a("th",null,s(o.value?"الموازنة المعتمدة":"Approved Budget"),1),a("th",null,s(o.value?"اسم الحساب":"Account Name"),1),a("th",null,s(o.value?"رقم الحساب":"Account Code"),1),a("th",null,s(o.value?"اسم البند":"Cost Center Name"),1),a("th",null,s(o.value?"رقم البند":"Cost Center Code"),1)])]),a("tbody",null,[(d(!0),u(D,null,N(c.value,(t,i)=>(d(),u("tr",{key:t.contract_id||i,class:p(["data-row",{"row-error":t.validation_errors&&t.validation_errors.length>0,"row-valid":!t.validation_errors||t.validation_errors.length===0}])},[a("td",nt,[a("button",{class:p(["btn-delete-row",{"btn-disabled":!f.value}]),onClick:l=>Ee(i),title:"Delete Row",disabled:!f.value},n[7]||(n[7]=[a("span",{class:"delete-icon"},"×",-1)]),10,ot),t.validation_errors&&t.validation_errors.length>0?(d(),u("div",{key:0,class:"validation-error-indicator",onClick:l=>Ne(t.validation_errors)},n[8]||(n[8]=[a("span",{class:"error-icon-small"},"!",-1)]),8,st)):(d(),u("div",lt,n[9]||(n[9]=[a("span",{class:"success-icon-small"},"✓",-1)])))]),a("td",rt,[U(a("input",{type:"text","onUpdate:modelValue":l=>t.to_center_input=l,class:p(["number-input",{"readonly-input":!f.value}]),onInput:l=>te(t,"to_center"),placeholder:o.value?"إلى":"To",readonly:!f.value},null,42,ct),[[pe,t.to_center_input]])]),a("td",ut,[U(a("input",{type:"text","onUpdate:modelValue":l=>t.from_center_input=l,class:p(["number-input",{"readonly-input":!f.value}]),onInput:l=>te(t,"from_center"),placeholder:o.value?"من":"From",readonly:!f.value},null,42,dt),[[pe,t.from_center_input]])]),a("td",it,[a("div",vt,s(m(t.encumbrance)||"-"),1)]),a("td",pt,[a("div",_t,s(m(t.available_budget)||"-"),1)]),a("td",bt,[a("div",ft,s(m(t.actual)||"-"),1)]),a("td",ht,[a("div",gt,s(m(t.approved_budget)||"-"),1)]),a("td",mt,s(t.account_name||ee(t.account_code)||"-"),1),a("td",null,[U(a("select",{"onUpdate:modelValue":l=>t.account_code=l,class:p(["account-select",{"readonly-input":!f.value}]),onChange:l=>Ce(t,l),disabled:!f.value},[a("option",wt,s(o.value?"اختر رقم الحساب":"Select Account"),1),(d(!0),u(D,null,N($.value,l=>(d(),u("option",{key:l.account,value:l.account},s(l.account),9,Ct))),128))],42,yt),[[_e,t.account_code]])]),a("td",Ft,s(t.cost_center_name||Z(t.cost_center_code)||"-"),1),a("td",null,[U(a("select",{"onUpdate:modelValue":l=>t.cost_center_code=l,class:p(["cost-center-select",{"readonly-input":!f.value}]),onChange:l=>we(t,l),disabled:!f.value},[a("option",kt,s(o.value?"اختر رقم البند":"Select Cost Center"),1),(d(!0),u(D,null,N(M.value,l=>(d(),u("option",{key:l.entity,value:l.entity},s(l.entity),9,Et))),128))],42,St),[[_e,t.cost_center_code]])])],2))),128))]),a("tfoot",null,[a("tr",Rt,[n[10]||(n[10]=a("td",null,null,-1)),a("td",At,s(m(F.value.toSum)||"-"),1),a("td",Dt,s(m(F.value.fromSum)||"-"),1),a("td",Nt,s(m(F.value.encumbranceSum)||"-"),1),a("td",Ut,s(m(F.value.availableBudgetSum)||"-"),1),a("td",Bt,s(m(F.value.actualSum)||"-"),1),a("td",Vt,s(m(F.value.approvedBudgetSum)||"-"),1),a("td",Tt,s(o.value?"المجموع الكلي":"Overall Sum"),1)]),a("tr",null,[a("td",Mt,[a("button",{class:p(["btn-add-row",{"btn-disabled":!f.value}]),onClick:ae,disabled:!f.value},[n[11]||(n[11]=a("span",{class:"add-icon"},"+",-1)),k(" "+s(o.value?"إضافة صف جديد":"Add New Row"),1)],10,$t)])])])])]),a("div",qt,s(o.value?`المجموع ${c.value.length}`:`Total ${c.value.length}`),1),a("div",xt,[a("button",{class:p(["btn-action btn-submit",{"btn-disabled":!G.value}]),onClick:Re,disabled:!G.value},[n[12]||(n[12]=a("span",{class:"btn-icon"},"→",-1)),k(" "+s(o.value?"تقديم":"Submit"),1)],10,It),a("button",{class:p(["btn-action btn-upload",{"btn-disabled":!Q.value}]),onClick:Ue,disabled:!Q.value},[n[13]||(n[13]=a("span",{class:"btn-icon"},"↑",-1)),k(" "+s(o.value?"رفع ملف العقد":"Upload Contract File"),1)],10,jt),a("button",{class:p(["btn-action btn-reopen",{"btn-disabled":!H.value}]),onClick:Ae,disabled:!H.value},[n[14]||(n[14]=a("span",{class:"btn-icon"},"↻",-1)),k(" "+s(o.value?"إعادة فتح الطلب":"Re-open Request"),1)],10,Lt),a("button",{class:"btn-action btn-report",onClick:De},[n[15]||(n[15]=a("span",{class:"btn-icon"},"📄",-1)),k(" "+s(o.value?"تقرير":"Report"),1)])]),ve(Oe,{show:x.value,"is-arabic":o.value,"transaction-id":_.value,"auth-token":je(L).token,onClose:Be,onUploadSuccess:Ve},null,8,["show","is-arabic","transaction-id","auth-token"])])),q.value?(d(),u("div",{key:3,class:"error-modal-overlay",onClick:oe},[a("div",{class:"error-modal-content",onClick:n[0]||(n[0]=Le(()=>{},["stop"]))},[a("div",Ot,[a("h3",null,s(o.value?"أخطاء التحقق":"Validation Errors"),1),a("button",{class:"error-modal-close",onClick:oe},"×")]),a("div",Pt,[a("ul",Jt,[(d(!0),u(D,null,N(ne.value,(t,i)=>(d(),u("li",{key:i},s(t),1))),128))])])])])):ie("",!0),ve(Pe,{show:I.value,"onUpdate:show":n[1]||(n[1]=t=>I.value=t),type:le.value,title:re.value,message:ce.value,timer:ue.value,showConfirmButton:!0,confirmButtonText:o.value?"موافق":"OK",onConfirm:Se},null,8,["show","type","title","message","timer","confirmButtonText"])],2))}},ta=Te(zt,[["__scopeId","data-v-520bfe47"]]);export{ta as default};
